<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Daftar Permintaan - Terhubung ke Google Sheets</title>
  <style>
    :root { --bg:#0f172a; --card:#111827; --muted:#94a3b8; --text:#e5e7eb; --accent:#38bdf8; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;background:linear-gradient(180deg,#0b1220,#0f172a 40%,#0b1220);color:var(--text)}
    header{position:sticky;top:0;background:rgba(15,23,42,.7);backdrop-filter: blur(8px);z-index:10;border-bottom:1px solid #1f2937}
    .container{max-width:1200px;margin:0 auto;padding:18px}
    h1{margin:0 0 6px 0;font-weight:700;font-size:clamp(18px,2.4vw,26px)}
    .sub{color:var(--muted);font-size:14px}
    .card{background:rgba(17,24,39,.65);border:1px solid #1f2937;border-radius:14px;padding:14px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    input[type="text"]{flex:1;min-width:220px;background:#0b1324;color:var(--text);border:1px solid #1f2937;border-radius:10px;padding:10px 12px;outline:none}
    input[type="text"]:focus{border-color:var(--accent)}
    .btn{background:#0b1324;border:1px solid #1f2937;color:var(--text);border-radius:10px;padding:10px 14px;cursor:pointer}
    .btn:hover{border-color:var(--accent)}
    .status{font-size:12px;color:var(--muted)}
    table{width:100%;border-collapse:separate;border-spacing:0}
    thead th{position:sticky;top:0;background:#0b1324;color:#cbd5e1;font-weight:600;text-align:left;padding:10px;border-bottom:1px solid #1f2937;cursor:pointer;white-space:nowrap}
    tbody td{padding:10px;border-bottom:1px solid #0f2239;vertical-align:top}
    tbody tr:hover{background:rgba(56,189,248,.06)}
    .wrap{overflow:auto;max-height:70vh;border:1px solid #1f2937;border-radius:12px}
    .tag{display:inline-block;padding:.2rem .5rem;border-radius:999px;border:1px solid #334155;color:#cbd5e1;font-size:12px}
    .foot{display:flex;gap:10px;align-items:center;justify-content:space-between;color:#a3b1c6;font-size:12px;margin-top:10px}
    .pager{display:flex;gap:6px;align-items:center}
    .pager button{padding:6px 10px;border-radius:8px;border:1px solid #1f2937;background:#0b1324;color:#d1d5db;cursor:pointer}
    .pager button[disabled]{opacity:.4;cursor:not-allowed}
    .select{background:#0b1324;color:var(--text);border:1px solid #1f2937;border-radius:10px;padding:8px}
    .hide{display:none}
  </style>
</head>
<body>
  <header>
    <div class="container">
      <h1>Daftar Permintaan</h1>
      <div class="sub">Sumber data: Google Sheets (publish to web → CSV). Klik judul kolom untuk sortir. Cari untuk memfilter semua kolom.</div>
    </div>
  </header>

  <main class="container">
    <div class="card">
      <div class="row">
        <input id="csvUrl" type="text" placeholder="Tempel URL CSV Google Sheets di sini lalu klik Muat" value="https://docs.google.com/spreadsheets/d/e/2PACX-1vQGcNZVux0v-_TsHYaWpRywJT_F4hnkdiC8eH0dXEIQwmU6Ma88px5u5cfnokguWtD87O9vNE-FOuak/pub?gid=0&single=true&output=csv"/>
        <button class="btn" id="loadBtn">Muat</button>
        <button class="btn" id="exportBtn">Ekspor tampilan (CSV)</button>
        <select id="pageSize" class="select">
          <option value="15">15/baris</option>
          <option value="25" selected>25/baris</option>
          <option value="50">50/baris</option>
          <option value="100">100/baris</option>
        </select>
      </div>
      <div class="row" style="margin-top:10px">
        <input id="search" type="text" placeholder="Cari… (nama, material, lokasi, kode, dll)"/>
        <div class="status" id="status">Belum ada data.</div>
      </div>
    </div>

    <div class="wrap" style="margin-top:14px">
      <table id="table" class="hide"></table>
    </div>
    <div class="foot">
      <div id="meta">0 baris</div>
      <div class="pager">
        <button id="prev">◀</button>
        <div id="pageInfo">0/0</div>
        <button id="next">▶</button>
      </div>
    </div>
  </main>

  <script>
    // ====== KONFIGURASI ======
    // URL default diisi dari input value; kalau mau hardcode, set di sini:
    const DEFAULT_CSV_URL = document.currentScript.closest('body').querySelector('#csvUrl').value;

    // ====== UTIL ======
    function parseCSV(text){
      const rows = [];
      let i = 0, cur = '', inQuotes = false, row = [];
      while(i < text.length){
        const c = text[i];
        if(c === '"'){
          if(inQuotes && text[i+1] === '"'){ cur += '"'; i++; }
          else inQuotes = !inQuotes;
        } else if(c === ',' && !inQuotes){ row.push(cur); cur=''; }
        else if((c === '\n' || c === '\r') && !inQuotes){
          if(cur !== '' || row.length){ row.push(cur); rows.push(row); row=[]; cur=''; }
          if(c==='\r' && text[i+1]==='\n') i++;
        } else { cur += c; }
        i++;
      }
      if(cur!=='' || row.length) { row.push(cur); rows.push(row); }
      return rows.filter(r=>r.length>1 || (r.length===1 && r[0]!==''));
    }

    function downloadCSV(filename, rows){
      const csv = rows.map(r=>r.map(v=>{
        const s = String(v ?? '');
        if(/[",\n]/.test(s)) return '"' + s.replaceAll('"','""') + '"';
        return s;
      }).join(',')).join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = filename; a.click();
      URL.revokeObjectURL(url);
    }

    function normalize(str){ return String(str||'').toLowerCase(); }

    // ====== STATE ======
    let data = []; let headers = []; let filtered = [];
    let sortKey = null; let sortDir = 'asc'; let page = 1; let pageSize = 25;

    // ====== RENDER ======
    const tableEl = document.getElementById('table');
    const statusEl = document.getElementById('status');
    const metaEl = document.getElementById('meta');
    const pageInfoEl = document.getElementById('pageInfo');

    function renderTable(){
      if(!headers.length){ tableEl.classList.add('hide'); return; }
      tableEl.classList.remove('hide');

      const thead = `<thead><tr>${headers.map(h=>{
        const is = sortKey===h; const arrow = is? (sortDir==='asc'?' ▲':' ▼') : '';
        return `<th data-col="${h}">${h}${arrow}</th>`;}).join('')}</tr></thead>`;

      const start = (page-1)*pageSize; const end = start+pageSize;
      const pageRows = filtered.slice(start,end);

      const tbody = `<tbody>${pageRows.map(r=>{
        return `<tr>${headers.map(h=>`<td>${(r[h]??'').toString().replace(/\n/g,'<br>')}</td>`).join('')}</tr>`;
      }).join('')}</tbody>`;

      tableEl.innerHTML = thead + tbody;

      tableEl.querySelectorAll('th').forEach(th=>{
        th.onclick = ()=>{
          const col = th.dataset.col;
          if(sortKey===col){ sortDir = (sortDir==='asc'?'desc':'asc'); }
          else { sortKey = col; sortDir = 'asc'; }
          sortData(); renderTable();
        };
      });

      const total = filtered.length;
      const pages = Math.max(1, Math.ceil(total/pageSize));
      if(page>pages){ page = pages; }
      metaEl.textContent = `${total} baris | halaman ${page} dari ${pages}`;
      pageInfoEl.textContent = `${page}/${pages}`;
      document.getElementById('prev').disabled = page<=1;
      document.getElementById('next').disabled = page>=pages;
    }

    function sortData(){
      if(!sortKey) return;
      const key = sortKey;
      const dir = sortDir==='asc'?1:-1;
      filtered.sort((a,b)=>{
        const va = a[key] ?? '';
        const vb = b[key] ?? '';
        const na = parseFloat(String(va).replace(/[^0-9.-]/g,''));
        const nb = parseFloat(String(vb).replace(/[^0-9.-]/g,''));
        const bothNumeric = !isNaN(na) && !isNaN(nb);
        if(bothNumeric){ return (na-nb)*dir; }
        return String(va).localeCompare(String(vb), 'id', {numeric:true}) * dir;
      });
    }

    function applySearch(q){
      const terms = normalize(q).split(/\s+/).filter(Boolean);
      if(!terms.length){ filtered = data.slice(); return; }
      filtered = data.filter(row=>{
        const joined = normalize(headers.map(h=>row[h]).join(' '));
        return terms.every(t=>joined.includes(t));
      });
    }

    async function loadCSV(url){
      statusEl.textContent = 'Mengambil data…';
      try{
        const res = await fetch(url);
        if(!res.ok) throw new Error('Gagal mengunduh CSV');
        const text = await res.text();
        const rows = parseCSV(text);
        headers = rows[0] || [];
        data = rows.slice(1).map(r=>{
          const obj = {}; headers.forEach((h,i)=> obj[h] = r[i] ?? '');
          return obj;
        });
        applySearch(document.getElementById('search').value);
        sortKey = null; page = 1; sortDir = 'asc';
        renderTable();
        statusEl.textContent = 'Sukses memuat data.';
      }catch(err){
        console.error(err);
        statusEl.textContent = 'Gagal memuat. Cek URL CSV Anda.';
        tableEl.classList.add('hide');
      }
    }

    document.getElementById('loadBtn').onclick = ()=>{
      const url = document.getElementById('csvUrl').value.trim() || DEFAULT_CSV_URL;
      if(!url) { alert('Tempel URL CSV dari Google Sheets terlebih dahulu.'); return; }
      loadCSV(url);
    };

    document.getElementById('exportBtn').onclick = ()=>{
      if(!headers.length) return;
      const rows = [headers, ...filtered.map(r=>headers.map(h=>r[h]??''))];
      downloadCSV('tampilan.csv', rows);
    };

    document.getElementById('search').addEventListener('input', (e)=>{
      applySearch(e.target.value);
      sortData();
      page = 1;
      renderTable();
    });

    document.getElementById('prev').onclick = ()=>{ if(page>1){ page--; renderTable(); } };
    document.getElementById('next').onclick = ()=>{ page++; renderTable(); };

    document.getElementById('pageSize').onchange = (e)=>{ pageSize = parseInt(e.target.value,10)||25; page=1; renderTable(); };

    // Auto-load saat halaman dibuka
    if(DEFAULT_CSV_URL){ loadCSV(DEFAULT_CSV_URL); }
  </script>
</body>
</html>
